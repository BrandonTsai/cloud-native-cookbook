<html>
<head>
  <style>
  table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
  }
  th, td {
    padding: 15px;
    text-align: left;
  }
  table#t01 {
    width: 100%;
    background-color: #f1f1c1;
  }
  h2 {
    margin-top: 35px;
  }
  h3, h4 {
    margin-top: 25px;
  }
  </style>
</head>
<body>
  
<p>Some companies use Splunk as the logging platform to store and to aggregate the logs for all their environments.
This post explains how to integrate Splunk with Kubernetes using the <a href="https://github.com/splunk/splunk-connect-for-kubernetes">Splunk-connect-for-kubernetes</a> helm charts.</p>
<h2>Architecture</h2>
<p>Splunk-connect-for-kubernetes contains 3 componenets:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td>logging</td>
<td>To collect container logs.</td>
</tr>
<tr>
<td>metric</td>
<td>To collect metrics, such as cpu/memory usage.</td>
</tr>
<tr>
<td>objects</td>
<td>To collect kubernetes resource status by calling the Kubernetes API.</td>
</tr>
</tbody>
</table>
<h2>Prerequisites</h2>
<ul>
<li>Allow connection from kubernetes to Splunk on HEC port 8088</li>
<li>Access to Dockerhub to pull images or import these images to your private registry.</li>
<li>Helm 3</li>
<li>splunk-connect-for-k8s v1.3.0</li>
</ul>
<h2>Splunk Setting</h2>
<h3>Create Splunk App (Optional)</h3>
<p>Create new app "kubernetes" or using exist app</p>
<blockquote>
<p>Note: The app must be 'visible' to be able to add indexes to it.</p>
</blockquote>
<h3>Create Splunk Indexes</h3>
<p>Create following indexes for the default indexes of http event collector</p>
<table>
<thead>
<tr>
<th>index name</th>
<th>type</th>
<th>app</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s_\<ENV>_logging</td>
<td>Events</td>
<td>kubernetes</td>
</tr>
<tr>
<td>k8s_\<ENV>_metrics</td>
<td>Metrics</td>
<td>kubernetes</td>
</tr>
<tr>
<td>k8s_\<ENV>_objects</td>
<td>Events</td>
<td>kubernetes</td>
</tr>
</tbody>
</table>
<p>Note:
- The size of each index should be tailored for the amount of data expected and not left as default
- \<ENV> is the environment name for the kubernetes cluster (such as UAT, PROD) if you using different kubernetes cluster for different environment.</p>
<h3>Push App setting to indexer cluster</h3>
<p><strong>Step 1.</strong> Copy app folder in splunk master instance</p>
<p>For app: "kubernetes", copy that app folder from /opt/splunk/etc/apps to /opt/splunk/etc/master-apps/</p>
<p><strong>Step 2.</strong> On Splunk UI,</p>
<ul>
<li>Click Settings &gt; Indexer Clustering.</li>
<li>Click Edit &gt; Configuration Bundle Actions.</li>
<li>Click Validate and Check Restart to check the bundle is valid</li>
<li>Click Push if the "Validate and Check Restart" result is fine.</li>
</ul>
<p><strong>Step 3.</strong> Check the splunk data</p>
<p>Check that any indexer replication issue has resolved and that Splunk is showing green. This will cause the Indexer servers to restart on initial push</p>
<h3>Create Splunk HTTP Event Collector Token</h3>
<p>Navigate to Settings &gt; Data Inputs &gt; HTTP Event Collector</p>
<blockquote>
<p><strong>Notice:</strong> Do NOT enable indexer acknowledgement when creating following tokens</p>
</blockquote>
<p>We need to create 3 HEC token for logging, metrics and object</p>
<table>
<thead>
<tr>
<th>HEC Token name</th>
<th>App Context</th>
<th>Select Allowed Indexes</th>
<th>Default index</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-\<ENV>-logging</td>
<td>kubernetes</td>
<td>k8s_\<ENV>_logging</td>
<td>k8s_\<ENV>_logging</td>
</tr>
<tr>
<td>k8s-\<ENV>-metrics</td>
<td>kubernetes</td>
<td>k8s_\<ENV>_metrics</td>
<td>k8s_\<ENV>_metrics</td>
</tr>
<tr>
<td>k8s-\<ENV>-objects</td>
<td>kubernetes</td>
<td>k8s_\<ENV>_objects</td>
<td>k8s_\<ENV>_objects</td>
</tr>
</tbody>
</table>
</body>
</html>